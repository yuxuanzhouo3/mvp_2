# 生产环境支付功能修复说明

## 🎯 修复概述

在准备将支付功能部署到生产环境（https://random-life-seven.vercel.app）时，发现并修复了以下问题：

### 1. URL 配置问题

**问题描述**：
代码中多处使用硬编码的 `localhost:3000` 或依赖 `NEXTAUTH_URL`，导致在生产环境中支付回调 URL 不正确。

**影响范围**：
- PayPal 支付成功/取消回调
- Stripe Checkout 会话回调
- 支付适配器中的 URL 生成

**修复方案**：
1. 创建了统一的 URL 工具函数 `/lib/utils/get-base-url.ts`
2. 更新了所有相关的 API 路由以使用该工具函数
3. 添加了新的环境变量 `NEXT_PUBLIC_APP_URL`

### 2. 环境变量配置优化

**新增环境变量**：
```bash
# 站点 URL 配置（生产环境必需）
NEXT_PUBLIC_APP_URL=https://random-life-seven.vercel.app
```

**URL 优先级**：
1. `NEXT_PUBLIC_APP_URL` - 公开的站点 URL（最高优先级）
2. `VERCEL_URL` - Vercel 部署的 URL
3. `NEXTAUTH_URL` - NextAuth 的 URL
4. `localhost:3000` - 开发环境默认值

## 🔧 修复的文件列表

1. **新增文件**：
   - `/lib/utils/get-base-url.ts` - 统一的 URL 获取工具

2. **修改的文件**：
   - `/app/api/paypal/create/route.ts` - PayPal 订单创建 API
   - `/app/api/stripe/create-checkout/route.ts` - Stripe Checkout API
   - `/app/api/paypal/create-subscription/route.ts` - PayPal 订阅 API
   - `/lib/payment/adapter.ts` - 支付适配器
   - `/.env.example` - 环境变量示例文件

## 📝 部署前检查清单

### 1. Vercel 环境变量配置

确保在 Vercel 项目中添加以下环境变量（Production 环境）：

```bash
# 基础配置
NEXT_PUBLIC_DEPLOYMENT_REGION=INTL
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=https://random-life-seven.vercel.app
NEXT_PUBLIC_APP_URL=https://random-life-seven.vercel.app

# Stripe 配置（生产环境）
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRO_PRICE_ID=price_xxx
STRIPE_ENTERPRISE_PRICE_ID=price_xxx

# PayPal 配置（生产环境）
PAYPAL_CLIENT_ID=Axxxxxxxx...
PAYPAL_CLIENT_SECRET=xxxxxxxx...
PAYPAL_WEBHOOK_ID=xx-xxxx-xxxxx
PAYPAL_PRO_PLAN_ID=P-xxxxxxxxxx
PAYPAL_ENTERPRISE_PLAN_ID=P-xxxxxxxxxx
```

### 2. Stripe 配置

- [ ] 切换到 Live 模式
- [ ] 创建产品和价格 ID
- [ ] 配置 Webhook 端点：`https://random-life-seven.vercel.app/api/stripe/webhook`

### 3. PayPal 配置

- [ ] 切换到 Live 环境
- [ ] 创建订阅计划
- [ ] 配置 Webhook URL：`https://random-life-seven.vercel.app/api/paypal/webhook`

### 4. 测试流程

1. **支付创建测试**
   - 测试 Stripe 支付意向创建
   - 测试 PayPal 订单创建
   - 验证返回的 URL 包含正确的域名

2. **支付回调测试**
   - 完成测试支付
   - 验证成功/失败页面重定向正确
   - 检查数据库中的支付记录更新

3. **Webhook 测试**
   - 使用 Stripe CLI 测试 webhook 事件
   - 使用 PayPal Webhook Simulator 测试
   - 验证订阅状态更新

## ⚠️ 注意事项

1. **密钥安全**：
   - 确保使用生产环境的密钥（不是测试密钥）
   - 不要在代码中硬编码任何密钥
   - 定期轮换 Webhook 签名密钥

2. **支付金额验证**：
   - 所有支付金额验证都在服务端进行
   - 客户端不能修改支付金额

3. **错误处理**：
   - 支付失败时提供清晰的错误信息
   - 记录所有支付相关的错误日志
   - 实现支付重试机制

## 🚀 部署命令

```bash
# 构建并部署到 Vercel
vercel --prod

# 或者使用 Vercel CLI
vercel env add NEXT_PUBLIC_APP_URL production
vercel env add STRIPE_SECRET_KEY production
# ... 添加其他环境变量
```

## 📞 问题排查

如果遇到问题，请检查：

1. **控制台日志**：
   - 查看 Vercel Functions 日志
   - 检查支付网关的 Dashboard

2. **常见错误**：
   - "Invalid callback URL" - 检查 `NEXT_PUBLIC_APP_URL` 配置
   - "Webhook verification failed" - 检查 Webhook 密钥配置
   - "Payment method not supported" - 确认支付网关配置正确

3. **测试环境**：
   - 可以先在 Vercel 的 Preview 环境中测试
   - 使用测试卡号和测试账户

## ✅ 验证清单

部署完成后，请验证：

- [ ] 用户可以成功创建 Stripe 支付
- [ ] 用户可以成功创建 PayPal 支付
- [ ] 支付成功后正确重定向
- [ ] 支付取消后正确重定向
- [ ] Webhook 事件正确处理
- [ ] 用户订阅状态正确更新
- [ ] 支付历史记录正确显示

---

如有任何问题，请参考：
- [生产环境支付配置清单.md](./生产环境支付配置清单.md)
- [Stripe 文档](https://stripe.com/docs)
- [PayPal 开发者文档](https://developer.paypal.com/docs/)